apiVersion: iter8.ibm.com/v1alpha1
kind: Canary
metadata:
  name: reviews
  namespace: default
spec:
  #if you have more than one revision running currently, experiment cannot proceed
  targetService: reviews # required
  experimentNow: True # default True
  candidate: reviews-v3 # optional; if this is not specified, canary = latest
  # match condition; optional
  match:
  - headers:
      user-agent:
      regex: "^(?!.*Chrome).*Safari.*"
  - headers:
      cookie:
        regex: "^(.*?;)?(type=insider)(;.*)?$"
  analysis:
    analyticsService: http://iter8analytics
    interval: 1m # optional; required only for live experiments
    experimentDeadline: 20m # optional; required only for live experiments
    warmupRequestCount: 100 # optional; required only for live experiments
    maxTrafficPercent: 50.0 #optional
    stepSize: 2.0 #optional
    AB: # all experiments are live experiments
      maximize: conversion_rate # we will make this a proper user defined metric
    metrics:
    - name: iter8_latency
      succeedOn:
        delta: 0.1 # 10% increase in latency is ok with me
        confidence: 98
      stopOn: # optional
        threshold: 1.2s
        minRequests: 75 # optional
    - name: iter8_error_rate
      succeedOn:
        threshold: 0.02
        confidence: 99.9
    - name: iter8_error_count
      stopOn:
        threshold: 20
    onSuccess: candidate # baseline, both
